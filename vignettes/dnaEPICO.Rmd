---
title: "The dnaEPICO User's Guide"
shorttitle: "dnaEPICO guide"
author: 
  - name: Paul Ruiz
    affiliation:
    - Queensland University of Technology
    email: ruizpint@qut.edu.au
  - name: Divya Metha
    affiliation:
    - Queensland University of Technology
abstract: >
  A comprehensive guide to using the dnaEPICO package. The package supports preprocessing and analysis of Illumina DNA methylation array data (EPICv2, EPIC and 450K), including QC, filtering, SVA, cell-type deconvolution, phenotype integration, modelling, and export-ready files for the DNAmAge Clock Foundation platform.
output: 
  BiocStyle::html_document:
    self_contained: yes
    toc: true
    toc_float: true
    toc_depth: 2
    code_folding: show
date: "`r Sys.Date()`"
package: dnaEPICO
bibliography: dnaEPICO.bib
vignette: >
  %\VignetteIndexEntry{Introduction to dnaEPICO}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}  
---

```{r setup, include = FALSE}
startTime <- Sys.time()
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>",
    crop = NULL ## Related to https://stat.ethz.ch/pipermail/bioc-devel/2020-April/016656.html
)
```

# Introduction

The **dnaEPICO** package supports preprocessing and analysis of Illumina DNA methylation array data (EPICv2, EPIC and 450K). It covers data import, quality control, surrogate variable analysis, probe and sample filtering, cell-type deconvolution, phenotype integration, and downstream modelling using generalised linear and linear mixed-effects models. The package integrates with Bioconductor workflows and tools including `minfi`, `ENmix`, and `wateRmelon`. Additional functionality is provided via the `ewastools` package, which is installed from GitHub using `devtools::install_github("hhhh5/ewastools")`. 

dnaEPICO also prepares standardised DNA methylation files for direct export to the [DNAmAge Clock Foundation platform](https://dnamage.clockfoundation.org/user).

## Citing `dnaEPICO`

The `r Biocpkg("dnaEPICO")` package implements methods described across multiple independent publications by different authors. As a result, no single manuscript fully describes all components of the package. This section provides guidance on how to cite dnaEPICO appropriately.

The citation guidance below is adapted from the user guides and vignettes of the packages on which dnaEPICO builds, [minfi](https://github.com/hansenlab/minfi/blob/devel/vignettes/minfi.Rmd), [ENmix](https://github.com/xuz1/ENmix/blob/master/vignettes/ENmix.Rmd), [wateRmelon](https://github.com/schalkwyk/wateRmelon/blob/master/vignettes/references.bib), and [ewastools](https://hhhh5.github.io/ewastools/articles/exemplary_ewas.html).

- If you use `preprocessingMinfiEwasWater()`, please cite [@minfi], [@minfiEPIC], [@ENmix], [@wateRmelon], [@SWAN], [@funnorm], [@noob] and [@quantile].
- If you use `svaEnmix()`, please cite [@minfi], [@ENmix], and [@ewastools].
- If you use `make f3 MODEL=model1`, please cite [@minfi], [@minfiEPIC], [@ENmix], [@wateRmelon], [@SWAN], [@funnorm], [@noob], [@quantile] and [@ewastools].
- If you use `make f4 MODEL=model1`, please cite [@minfi], [@minfiEPIC], [@ENmix], [@wateRmelon], [@SWAN], [@funnorm], [@noob], [@quantile], [@ewastools] and [@glm2].
- If you use `make f3lme MODEL=model1`, please cite [@minfi], [@minfiEPIC], [@ENmix], [@wateRmelon], [@SWAN], [@funnorm], [@noob], [@quantile], [@ewastools] and [@lme4].
- If you use `make all MODEL=model1`, please cite [@minfi], [@minfiEPIC], [@ENmix], [@wateRmelon], [@SWAN], [@funnorm], [@noob], [@quantile], [@ewastools], [@glm2] and [@lme4]. 

# Installation

`r Biocpkg("dnaEPICO")` implements methods in `r Biocpkg("minfi")`, `r Biocpkg("ENmix")` and `r Biocpkg("wateRmelon")` packages so there is quite the number of dependencies which need to be installed. Additional functionality is provided via the `ewastools` package. This can be handled by simply running:

```{r "install", eval = FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE)) {
      install.packages("BiocManager")
  }

BiocManager::install("dnaEPICO")

BiocManager::valid()

```

```{r "github", eval = FALSE}
devtools::install_github("hhhh5/ewastools")

```

```{r "start", message=FALSE, eval = FALSE}
library("dnaEPICO")
library("ewastools")

```

Alternatively, `r Biocpkg("dnaEPICO")` can be installed directly from our
[github](https://github.com/paulYRP/dnaEPICO)

```{r, eval= FALSE, echo= TRUE}
install.packages('devtools')
devtools::install_github('paulYRP/dnaEPICO')

```

# Overview

`r Biocpkg("dnaEPICO")` is a DNA methylation preprocessing and modelling pipeline designed for Illumina arrays. It wraps reproducible analysis steps into a consistent structure that:

* reads **IDATs** and phenotype metadata,
* performs **QC**, filtering and normalisation,
* computes surrogate variables (**SVA**),
* **merges phenotype** with methylation matrices,
* runs **GLM** (cross-sectional) and **GLMM/LME** (longitudinal) models,
* writes **logs**, **figures**, **RData objects**, and a **PDF report**.

A core design principle is that each step creates its own folders and outputs, so you can run steps independently or chain them through the Makefile pipeline.

## Local/Cluster use

**Local use** is recommended for:

* testing the pipeline end-to-end on a small subset,
* preparing clean merged data objects,
* generating QC plots and logs,
* validating input formatting and parameter choices.

**Cluster/HPC use** is recommended for:

* genome-wide modelling (hundreds of thousands of CpGs),
* parallel chunk processing,
* large memory operations and multi-core execution,
* reproducible batch execution with Make targets (`f3`, `f4`, `f3lme` and `all`).

# Data expectations and folder conventions

`r Biocpkg("dnaEPICO")` expects:

```make
├── data/                                   # Processed data outputs (per model)
│   ├── preprocessingMinfiEwasWater/
│   │   ├── idats/                          # Folder containing raw IDAT files
│   │   ├── pheno.csv                       # Phenotype file with sample metadata
│   │   └── 12864_2024_10027_MOESM8_ESM.csv # Cross-reactivity comparison reference
│   ├── Makefile                            # Arguments 
```

* **Phenotype file**: a CSV with sample identifiers and covariates.
* **IDAT folder**: contains Illumina `*_Red.idat` and `*_Grn.idat` pairs.
* **Output folders**: created by each step (logs, rData, figures, reports).

You can download the list of off-target cross-hybridisation sites for EPICv2 probes from [`12864_2024_10027_MOESM8_ESM.csv`](https://springernature.figshare.com/articles/dataset/Additional_file_8_of_Characterisation_and_reproducibility_of_the_HumanMethylationEPIC_v2_0_BeadChip_for_DNA_methylation_profiling/26689706?file=48531323).

You can extract the `Makefile` using:

```{r, eval=FALSE}
extractMake(
  destDir = getwd(),
  overwrite = FALSE
  )

```

`r Biocpkg("dnaEPICO")` generates:

```make
├── data/                                   # Processed data outputs (per model)
│   ├── preprocessingMinfiEwasWater/
│   │   ├── idats/                          # Folder containing raw IDAT files
│   │   ├── pheno.csv                       # Phenotype file with sample metadata
│   │   └── 12864_2024_10027_MOESM8_ESM.csv # Cross-reactivity comparison reference
│   ├── model1/                             # Outputs specific to the first model
│   │   ├── preprocessingMinfiEwasWater/    # Preprocessed phenotype + QC from Minfi
│   │   ├── svaEnmix/                       # Surrogate variable analysis 
│   │   ├── preprocessingPheno/             # Cleaned and merged phenotype files 
│   │   ├── methylationGLM_T1/              # CpG-level GLM results (single timepoint)
│   │   ├── methylationGLMM_T1T2/           # Longitudinal LME results (T1 vs T2)
│   │   └── ...                             # Additional subfolders by model
│   ├── model2/
│   └── model3/
├── rData/                                  # Processed R objects (MSet, Beta, CN matrices, etc.)
├── logs/                                   # Logging output from script runs
├── figures/                                # QC plots and visualization output
├── results/                                # Output tables and summary statistics
├── reports/                                # Optional rendered reports (PDF)
```

Each step writes:

* `logs/`: logs
* `rData/`: intermediate and final R objects
* `figures/`: plots organised by step name
* `data/`: exported tables (annotated results, phenotype exports)
* `reports/`: final PDF report

This *“each function writes to its own folder”* approach is intentional: it improves reproducibility, debugging, and HPC resuming.

# Local use

Local use focuses on the first three steps that are commonly run interactively:

1. `preprocessingMinfiEwasWater()`: import + QC + normalise + filter + cell composition
2. `svaEnmix()`: surrogate variable analysis using ENmix control probes
3. `preprocessingPheno()`: merge phenotype metadata with methylation matrices

## Step 1: `preprocessingMinfiEwasWater()`

```{r, eval=FALSE}
preprocessingMinfiEwasWater(
    phenoFile = "data/preprocessingMinfiEwasWater/pheno.csv",
    idatFolder = "data/preprocessingMinfiEwasWater/idats",
    outputLogs = "logs",
    nSamples = NA,
    SampleID = "Sample_Name",
    arrayType = "IlluminaHumanMethylationEPICv2",
    annotationVersion = "20a1.hg38",
    scriptLabel = "preprocessingMinfiEwasWater",
    baseDataFolder = "rData",
    sepType = "",
    tiffWidth = 2000,
    tiffHeight = 1000,
    tiffRes = 150,
    qcCutoff = 10.5,
    detPtype = "m+u",
    detPThreshold = 0.05,
    funnormSeed = 123,
    normMethods = "adjustedfunnorm",
    sexColumn = "Sex",
    pvalThreshold = 0.01,
    chrToRemove = "chrX,chrY",
    snpsToRemove = "SBE,CpG",
    mafThreshold = 0.1,
    crossReactivePath =
      "data/preprocessingMinfiEwasWater/12864_2024_10027_MOESM8_ESM.csv",
    plotGroupVar = "Sex",
    lcRef = "salivaEPIC",
    phenoOrder = "Sample_Name;Timepoint;Sex;PredSex;Basename;Sentrix_ID;Sentrix_Position",
    lcPhenoDir = "data/preprocessingMinfiEwasWater"
)
```

### What it does:

This wrapper executes the pipeline script in `inst/scripts/preprocessingMinfiEwasWater.R` using `Rscript`. Conceptually, it:

1. Reads phenotype CSV (`phenoFile`) and IDATs (`idatFolder`).
2. Loads an `RGChannelSet` (minfi) and runs basic QC.
3. Creates `MSet`/`RatioSet`/`GenomicRatioSet` objects.
4. Computes detection p-values and filters failed probes/samples.
5. Applies normalisation (`normMethods`).
6. Performs probe filtering (p-value, chrX/Y removal, SNP filters, cross-reactive probes).
7. Exports final matrices (Beta/M/CN) to `rData/`.
8. Produces plots in `figures/` and logs in `logs/`.
9. Optionally estimates cell composition (via `lcRef`) and writes `phenoLC.csv` into `lcPhenoDir`.

### Parameter guide:

* `phenoFile`: where your sample metadata lives (CSV).
* `idatFolder`: directory with IDAT pairs.
* `nSamples`: subset for testing locally (e.g. `5`).
* `SampleID`: name of the sample ID column in your phenotype file.
* `arrayType`, `annotationVersion`: ensures the correct manifest/annotation is used.
* `qcCutoff`, `detPtype`, `detPThreshold`: QC rules; detection p-value is used to flag failed probes/samples.
* `normMethods`: normalisation method(s) you want to apply.
* `pvalThreshold`, `chrToRemove`, `snpsToRemove`, `mafThreshold`: probe-level filters.
* `crossReactivePath`: CSV containing cross-reactive probes to remove.
* `phenoOrder`: a semicolon-delimited string that defines how the final phenotype table is ordered.
* `lcRef`, `lcPhenoDir`: cell composition reference + output for pheno with cell fractions.

## Step 2: `svaEnmix()`

```{r, eval=FALSE}
svaEnmix(
    phenoFile = "data/preprocessingMinfiEwasWater/phenoLC.csv",
    rgsetData = "rData/preprocessingMinfiEwasWater/objects/RGSet.RData",
    sepType = "",
    outputLogs = "logs",
    nSamples = NA,
    SampleID = "Sample_Name",
    arrayType = "IlluminaHumanMethylationEPICv2",
    annotationVersion = "20a1.hg38",
    SentrixIDColumn = "Sentrix_ID",
    SentrixPositionColumn = "Sentrix_Position",
    ctrlSvaPercVar = 0.90,
    ctrlSvaFlag = 1,
    scriptLabel = "svaEnmix",
    tiffWidth = 2000,
    tiffHeight = 1000,
    tiffRes = 150
)
```

### What it does:

This wrapper executes `inst/scripts/svaEnmix.R`. Conceptually, it:

1. Loads `RGSet` from `rgsetData` and phenotype from `phenoFile`.
2. Uses ENmix control probes to derive control-based components.
3. Chooses how many components to keep based on `ctrlSvaPercVar`.
4. Writes summary outputs, figures, and updated objects/logs.

### Parameter guide:

* `rgsetData`: the saved object from Step 1 (input to SVA).
* `phenoFile`: `phenoLC.csv` from Step 1 (includes cell fractions).
* `ctrlSvaPercVar`: proportion of variance to capture using control-derived SVs.
* `SentrixIDColumn`, `SentrixPositionColumn`: needed to match the array sample structure.

## Step 3: `preprocessingPheno()`

```{r, eval=FALSE}
preprocessingPheno(
    phenoFile = "data/preprocessingMinfiEwasWater/phenoLC.csv",
    sepType = "",
    betaPath =
      "rData/preprocessingMinfiEwasWater/metrics/beta_NomFilt_MSetF_Flt_Rxy_Ds_Rc.RData",
    mPath =
      "rData/preprocessingMinfiEwasWater/metrics/m_NomFilt_MSetF_Flt_Rxy_Ds_Rc.RData",
    cnPath =
      "rData/preprocessingMinfiEwasWater/metrics/cn_NomFilt_MSetF_Flt_Rxy_Ds_Rc.RData",
    SampleID = "Sample_Name",
    timeVar = "Timepoint",
    timepoints = "1,2",
    combineTimepoints = "1,2",
    outputPheno = "data/preprocessingPheno",
    outputRData = "rData/preprocessingPheno/metrics",
    outputRDataMerge = "rData/preprocessingPheno/mergeData",
    sexColumn = "Sex",
    outputLogs = "logs",
    outputDir = "data/preprocessingPheno"
)
```

### What it does:

This wrapper executes `inst/scripts/preprocessingPheno.R`. Conceptually, it:

1. Loads phenotype and methylation matrices (Beta/M/CN).
2. Aligns samples by `SampleID`.
3. Creates timepoint-specific subsets (`timepoints`).
4. Optionally combines timepoints (`combineTimepoints`) for longitudinal sets.
5. Writes:

   * exported phenotype tables into `outputPheno`,
   * methylation metric objects into `outputRData`,
   * merged objects (e.g., `phenoBetaT1.RData`) into `outputRDataMerge`.
   
### Parameter guide:

* `phenoFile`: `phenoLC.csv` generated in Step 1.
* `betaPath`, `mPath`, `cnPath`: paths to saved methylation metric objects (Beta, M, and CN matrices) produced during preprocessing.
* `SampleID`: column name in the phenotype file used to match samples to methylation matrices.
* `timeVar`: phenotype column that defines the time variable (e.g. baseline, follow-up).
* `timepoints`: comma-separated list of timepoints to subset and export individually.
* `combineTimepoints`: comma-separated list of timepoints to merge into a single longitudinal dataset.
* `outputPheno`: directory where cleaned and subsetted phenotype tables are written.
* `outputRData`: directory where timepoint-specific methylation metric objects are saved.
* `outputRDataMerge`: directory where merged phenotype–methylation objects are written.
* `sexColumn`: column used to store biological sex.
* `outputLogs`: directory where execution logs are written.
* `outputDir`: base directory for exported data products generated by this step.

This step prepares analysis-ready phenotype–methylation objects for downstream GLM and LME modelling and generates files compatible with the DNAmAge Clock Foundation platform (see your `log_preprocessingPheno.txt` for details).

# Cluster / HPC use

On full datasets, model fitting across hundreds of thousands of CpGs typically requires:

* large memory,
* parallel chunking,
* long runtimes.

`dnaEPICO` supports this with a Makefile-driven pipeline that can run the pipeline end-to-end or by grouped targets.

## Step 4: `methylationGLM_T1()`

This step is typically executed on **HPC systems** due to memory and CPU requirements.

```{r, eval=FALSE}
methylationGLM_T1(
    inputPheno = "rData/preprocessingPheno/mergeData/phenoBetaT1.RData",
    outputLogs = "logs",
    outputRData = "rData/methylationGLM_T1/models",
    outputPlots = "figures/methylationGLM_T1",
    phenotypes = "Pheno1,Pheno2,Pheno3,Pheno4",
    covariates = "Sex,Age,Ethnicity,TraumaDefinition,Leukocytes,Epithelial.cells",
    factorVars = "Sex,Ethnicity,TraumaDefinition",
    cpgPrefix = "cg",
    cpgLimit = NA,
    nCores = 32,
    plotWidth = 2000,
    plotHeight = 1000,
    plotDPI = 150,
    interactionTerm = NULL,
    libPath = NULL,
    glmLibs = "glm2",
    prsMap = "Pheno1:PRS_1,Pheno2:PRS_2,Pheno3:PRS_3,Pheno4:PRS_4",
    summaryPval = NA,
    summaryResidualSD = TRUE,
    saveSignificantCpGs = FALSE,
    significantCpGDir = "preliminaryResults/cpgs/methylationGLM_T1",
    significantCpGPval = 0.05,
    saveTxtSummaries = TRUE,
    chunkSize = 10000,
    summaryTxtDir = "preliminaryResults/summary/methylationGLM_T1/glm",
    fdrThreshold = 0.05,
    padjmethod = "fdr",
    annotationPackage = "IlluminaHumanMethylationEPICv2anno.20a1.hg38",
    annotationCols = "Name,chr,pos,UCSC_RefGene_Group,UCSC_RefGene_Name,
                      Relation_to_Island,GencodeV41_Group",
    annotatedGLMOut = "data/methylationGLM_T1"
) 
```

### What it does:

This wrapper executes the external script `inst/scripts/methylationGLM_T1.R` using a system call. Conceptually, it:

1. Loads a merged phenotype–beta-value object (`inputPheno`) produced by `preprocessingPheno()`.
2. Iterates over CpGs in chunks and fits a generalised linear model [(glm2)](https://cran.r-project.org/web/packages/glm2/index.html) for each CpG.
3. Models each specified phenotype separately, adjusting for covariates and factor variables.
4. Optionally includes interaction terms and polygenic risk score (PRS) mappings.
5. Applies multiple-testing correction (FDR).
6. Writes:

   * fitted model objects to `outputRData`,
   * diagnostic and summary plots to `outputPlots`,
   * log files to `outputLogs`,
   * text summaries and significant CpG tables,
   * annotated result tables using the specified annotation package.

### Parameter guide:

* `inputPheno`: path to the merged phenotype–beta-value `.RData` file (e.g. `phenoBetaT1.RData`).
* `outputLogs`: directory where model execution logs are written.
* `outputRData`: directory where fitted GLM model objects are saved.
* `outputPlots`: directory where plots (e.g. p-value distributions, diagnostics) are written.
* `phenotypes`: comma-separated list of phenotype variables to model independently.
* `covariates`: comma-separated list of covariates included in each GLM.
* `factorVars`: subset of covariates treated as categorical variables.
* `cpgPrefix`: prefix used to identify CpG probes (usually `"cg"`).
* `cpgLimit`: maximum number of CpGs to analyse (useful for testing); `NA` runs all CpGs.
* `nCores`: number of CPU cores used for parallel processing.
* `plotWidth`, `plotHeight`, `plotDPI`: dimensions and resolution of generated plots.
* `interactionTerm`: optional interaction term (e.g. `phenotype:timepoint`); `NULL` disables interactions.
* `libPath`: optional library path for HPC environments.
* `glmLibs`: GLM backend library to use (e.g. `glm2`).
* `prsMap`: optional PRS mapping file to include genetic predictors.
* `summaryPval`: p-value threshold for generating summary outputs; `NA` disables filtering.
* `summaryResidualSD`: logical flag to summarise residual standard deviations.
* `saveSignificantCpGs`: whether to save CpGs passing `significantCpGPval`.
* `significantCpGDir`: directory where significant CpG tables are written.
* `significantCpGPval`: p-value threshold for defining significant CpGs.
* `saveTxtSummaries`: whether to save per-model text summaries.
* `chunkSize`: number of CpGs processed per chunk to control memory usage.
* `summaryTxtDir`: directory for text-based model summaries.
* `fdrThreshold`: FDR threshold used for adjusted p-values.
* `padjmethod`: multiple-testing correction method (e.g. `"fdr"`).
* `annotationPackage`: annotation package used to annotate CpGs.
* `annotationCols`: comma-separated annotation fields to extract.
* `annotatedGLMOut`: directory where annotated GLM result tables are written.


### GLM structure used in dnaEPICO (`glm2`):

For each CpG site ( cg_i ), dnaEPICO fits a generalised linear model of the form:

$$
\text{Methylation}*{cg_i} =
\beta_0 +
\beta_1 \cdot \text{Phenotype} +
\sum*{k=1}^{K} \beta_{k+1} \cdot \text{Covariate}*k +
\varepsilon
$$

where methylation is typically represented as **M-values** (or Beta-values, depending on configuration).


### GLM without PRS (default):

$$
\begin{aligned}
\text{Methylation}_{cg_i} = \;&
\beta_0 +
\beta_1 \cdot \text{Phenotype} +
\beta_2 \cdot \text{Age} +
\beta_3 \cdot \text{Sex} +
\beta_4 \cdot \text{Ethnicity} + \\
&+
\beta_5 \cdot \text{TraumaDefinition} +
\beta_6 \cdot \text{Leukocytes} +
\beta_7 \cdot \text{Epithelial.cells} +
\varepsilon
\end{aligned}
$$

**Mapping to dnaEPICO parameters**

* **Phenotype**:`phenotypes`
* **Age, Sex, Ethnicity, TraumaDefinition, Leukocytes, Epithelial.cells**: `covariates`
* **Sex, Ethnicity, TraumaDefinition**: converted to `factorVars`
* (\varepsilon): residual error term

### GLM with PRS:

When a PRS is supplied via `prsMap`, the model is **extended only for the matching phenotype**.

From the example above:

prsMap = "Pheno1:PRS_1,Pheno2:PRS_2,Pheno3:PRS_3,Pheno4:PRS_4"


This defines a **one-to-one mapping** between phenotype and PRS. For example:

* Pheno1 with PRS_1 

$$
\text{Methylation}*{cg_i} =
\beta_0 +
\beta_1 \cdot \text{Pheno1} +
\sum*{k=1}^{K} \beta_{k+1} \cdot \text{Covariate}*k +
\beta*{\text{PRS}} \cdot \text{PRS_1} +
\varepsilon
$$

* Pheno2 with PRS_2

$$
\text{Methylation}*{cg_i} =
\beta_0 +
\beta_1 \cdot \text{Pheno2} +
\sum*{k=1}^{K} \beta_{k+1} \cdot \text{Covariate}*k +
\beta*{\text{PRS}} \cdot \text{PRS_2} +
\varepsilon
$$


### Interaction term

If an interaction is specified (e.g. phenotype × timepoint):

$$
\text{Methylation}*{cg_i} =
\ldots +
\beta*{int} \cdot (\text{Phenotype} \times \text{Timepoint}) +
\varepsilon
$$

**Mapping**

* Interaction definition: `interactionTerm`

## Step 5: `methylationGLMM_T1T2()`

This step is typically executed on **HPC systems** due to memory and CPU requirements.

```{r, eval=FALSE}
methylationGLMM_T1T2(
    inputPheno = "rData/preprocessingPheno/mergeData/phenoBetaT1T2.RData",
    outputLogs = "logs/",
    outputRData = "rData/methylationGLMM_T1T2/models",
    outputPlots = "figures/methylationGLMM_T1T2",
    personVar = "person",
    timeVar = "Timepoint",
    phenotypes = "Pheno1,Pheno2,Pheno3,Pheno4",
    covariates = "Sex,Age,Ethnicity,TraumaDefinition,Leukocytes,Epithelial.cells",
    factorVars = "Sex,Ethnicity,TraumaDefinition,Timepoint",
    lmeLibs = "lme4,lmerTest",
    prsMap = "Pheno1:PRS_1,Pheno2:PRS_2,Pheno3:PRS_3,Pheno4:PRS_4",
    libPath = NULL,
    cpgPrefix = "cg",
    cpgLimit = NA,
    nCores = 32,
    summaryPval = NA,
    plotWidth = 2000,
    plotHeight = 1000,
    plotDPI = 150,
    interactionTerm = NULL,
    saveSignificantInteractions = TRUE,
    significantInteractionDir = "preliminaryResults/cpgs/methylationGLMM_T1T2",
    significantInteractionPval = 0.05,
    saveTxtSummaries = TRUE,
    chunkSize = 10000,
    summaryTxtDir = "preliminaryResults/summary/methylationGLMM_T1T2/lmer",
    fdrThreshold = 0.05,
    padjmethod = "fdr",
    annotationPackage = "IlluminaHumanMethylationEPICv2anno.20a1.hg38",
    annotationCols = "Name,chr,pos,UCSC_RefGene_Group,UCSC_RefGene_Name,
                      Relation_to_Island,GencodeV41_Group",
    annotatedLMEOut = "data/methylationGLMM_T1T2"
)
```

### What it does:

This wrapper executes the external script `inst/scripts/methylationGLMM_T1T2.R` using a system call. Conceptually, it:

1. Loads a merged **longitudinal phenotype–methylation** object (`inputPheno`) created by `preprocessingPheno()`.
2. Iterates over CpGs in chunks and fits a linear mixed-effects model [(lme4)](https://cran.r-project.org/web/packages/lme4/index.html).
3. Fits **one model per phenotype**, accounting for repeated measures using a subject-level random effect.
4. Models fixed effects for phenotype, time, covariates, and optional interactions.
5. Optionally includes **phenotype-specific PRS terms** based on `prsMap`.
6. Tests interaction terms (e.g. phenotype × timepoint).
7. Applies multiple-testing correction across CpGs.
8. Writes:

   * fitted model objects to `outputRData`,
   * plots to `outputPlots`,
   * log files to `outputLogs`,
   * text summaries,
   * tables of significant interaction CpGs,
   * annotated result tables using the specified annotation package.

### Parameter guide:

* `inputPheno`: path to the merged longitudinal phenotype–methylation `.RData` file (e.g. `phenoBetaT1T2.RData`).
* `outputLogs`: directory where execution logs are written.
* `outputRData`: directory where fitted mixed-effects model objects are saved.
* `outputPlots`: directory where model diagnostics and summary plots are written.
* `personVar`: subject identifier used as a random effect (e.g. participant ID).
* `timeVar`: variable defining the longitudinal time dimension.
* `phenotypes`: comma-separated list of phenotype variables.
* `covariates`: comma-separated list of covariates included as fixed effects.
* `factorVars`: subset of variables treated as categorical (typically includes `timeVar`).
* `lmeLibs`: mixed-effects modelling libraries used (e.g. `lme4`, `lmerTest`).
* `prsMap`: optional phenotype-to-PRS mapping; PRS terms are included **only for mapped phenotypes**.
* `libPath`: optional library path for HPC environments.
* `cpgPrefix`: prefix used to identify CpG probes (usually `"cg"`).
* `cpgLimit`: maximum number of CpGs to analyse; `NA` analyses all CpGs.
* `nCores`: number of CPU cores used for parallel processing.
* `summaryPval`: p-value threshold for generating summaries; `NA` disables filtering.
* `plotWidth`, `plotHeight`, `plotDPI`: dimensions and resolution of generated plots.
* `interactionTerm`: interaction term to test (commonly `timeVar`); `NULL` disables interaction testing.
* `saveSignificantInteractions`: logical flag indicating whether significant interaction CpGs are saved.
* `significantInteractionDir`: directory where significant interaction results are written.
* `significantInteractionPval`: p-value threshold defining significant interactions.
* `saveTxtSummaries`: whether to save per-model text summaries.
* `chunkSize`: number of CpGs processed per chunk to manage memory usage.
* `summaryTxtDir`: directory for text-based model summaries.
* `fdrThreshold`: FDR threshold applied to interaction p-values.
* `padjmethod`: multiple-testing correction method (e.g. `"fdr"`).
* `annotationPackage`: annotation package used to annotate CpGs.
* `annotationCols`: comma-separated annotation fields to extract.
* `annotatedLMEOut`: directory where annotated mixed-model result tables are written.

### LMEM structure used in dnaEPICO (`lme4`):

For longitudinal analyses, the phenotype-specific structure remains, with additional random and interaction terms:

$$
\begin{aligned}
\text{Methylation}*{cg_i} = \;&
\beta_0^{(p)} +
\beta_1^{(p)} \cdot p +
\beta_2^{(p)} \cdot \text{Timepoint} +
\beta_3^{(p)} \cdot (p \times \text{Timepoint}) + \\
&+
\beta*{\text{PRS}}^{(p)} \cdot \text{PRS}*p +
b*{\text{person}} +
\varepsilon^{(p)}
\end{aligned}
$$

where (\text{PRS}_p) is included **only if it is defined for phenotype (p)**. The logic follows that of `methylationGLM_T1()`.

# Makefile pipeline concepts

* `Makefile.model.pipeline`: user configuration (models, variables, paths)
* `Makefile.rules.pipeline`: pipeline targets and rules

## Extracting `Makefile.model.pipeline` into a working directory

## Copies the example Makefile into the current directory
extractMake(destDir = getwd(), overwrite = FALSE)


The internal template `Makefile.model.pipeline` is copied and renamed to `Makefile` in the destination directory.

## Make targets: f3, f4, f3lme and all

Common grouped targets:

* `f3`: Steps 1–3 (preprocessing + SVA + merge)
* `f4`: Steps 1–4 (adds GLM)
* `f3lme`: Steps 1-3 and 5 (adds LME4)
* `all`: Steps 1–5 

### Commands

- Show status of pipeline outputs
  - make status MODEL=model1
- Run steps 1–3 for one model
  - make f3 MODEL=model1
- Run steps 1–4 for one model
  - make f4 MODEL=model1
- Run steps 1–3 and 5 for one model
  - make f3lme MODEL=model1
- Run full pipeline
  - make all MODEL=model1
- Run multiple models
  - make models # run the entire pipeline for all models in parallel.
  - make f3_models # run Steps 1–3 in parallel for all models.
  - make f4_models # run Steps 1–4 in parallel for all models.
  - make f3lme_models # run Steps 1–3 + LME in parallel for all models

## Makefile Modelling steps (HPC)

This Makefile defines **how dnaEPICO models are executed at scale**, controlling:

* which phenotype files are used,
* which statistical models are run,
* how GLM (`glm2`) and GLMM (`lme4`) are parameterised,
* how results are organised and reproduced across models.

Rather than hard-coding parameters in R scripts, dnaEPICO uses a **declarative Makefile layer** so the same pipeline can be re-run with different configurations.

```make
# ===============================================
# USER CONFIGURATION
# ===============================================
MAKEFLAGS += --output-sync

# ===============================================
# MODELS SELECTION PARALLEL RUN
# ===============================================
MODEL ?= model1 # Single model
MODELS = modelA modelB modelC # Multiple models for parallel run

# ===============================================
# PER-MODEL OVERRIDES
# ===============================================
ifeq ($(MODEL), modelA)
  PHENO_FILE = $(DATA_DIR)/$(STEP1)/phenoA.csv


else ifeq ($(MODEL), modelB)
  PHENO_FILE = $(DATA_DIR)/$(STEP1)/phenoB.csv

else ifeq ($(MODEL), modelC)
  PHENO_FILE = $(DATA_DIR)/$(STEP1)/phenoC.csv

else # default (model1)
  PHENO_FILE = $(DATA_DIR)/$(STEP1)/pheno.csv

endif

# ===============================================
# DIRECTORIES
# ===============================================
LOGS_DIR = logs
DATA_DIR = data
RDATA_DIR = rData
RESULTS_DIR = results
FIGURES_DIR = figures
STEP1 = preprocessingMinfiEwasWater
STEP2 = svaEnmix
STEP3 = preprocessingPheno
STEP4 = methylationGLM_T1
STEP5 = methylationGLMM_T1T2
STEP6 = reports
METRICS_DIR = metrics
IDAT_DIR = idats
OBJ_DIR = objects
MERGE_DIR = mergeData
MODEL_DIR = models
CPG_DIR = cpgs
SUMMARY_DIR = summary
ENMIX_DIR = enmix
SVA_DIR = sva
QC_DIR = qc
R_DIR = ~/R/x86_64-pc-linux-gnu-library/4.4 # NULL is default R library path

# ===============================================
# GLOBAL PARAMETERS
# ===============================================
# STEP 1-5 PARAMETERS
PHENO_FILE = $(DATA_DIR)/$(STEP1)/phenoEMD.csv
SEP_TYPE = ""
SAMPLE_ID = Sample_Name
N_SAMPLES = 30
ARRAY_TYPE = IlluminaHumanMethylationEPICv2
ANNOTATION_VERSION = 20a1.hg38
TIFF_WIDTH = 2000
TIFF_HEIGHT = 1000
TIFF_RES = 150
SEX_COLUMN = Sex
SENTRIX_ID_COLUMN = Sentrix_ID
SENTRIX_POSITION_COLUMN = Sentrix_Position
BASENAME_COLUMN = Basename
TIME_VAR = Timepoint
PHENO_ORDER = $(SAMPLE_ID);$(TIME_VAR);$(SEX_COLUMN);PredSex;$(BASENAME_COLUMN);$(SENTRIX_ID_COLUMN);$(SENTRIX_POSITION_COLUMN)

# STEP 4-5 PARAMETERS
PHENOTYPES = TreatmentGroup
COVARIATES = Sex
FACTOR_VARS = Sex,TreatmentGroup
CPG_PREFIX = cg
CPG_LIMIT = NA
PRS_MAP = NULL
SUMMARY_PVAL = NA
N_CORES = 64
SAVE_TXT_SUMMARIES = TRUE
CHUNK_SIZE = 10000
FDR_THRESHOLD = 0.05
PADJ_METHOD = fdr
ANNOTATION_PACKAGE = IlluminaHumanMethylationEPICv2anno.20a1.hg38
ANNOTATION_COLS = Name,chr,pos,UCSC_RefGene_Group,UCSC_RefGene_Name,Relation_to_Island,GencodeV41_Group

# ===============================================
# STEP 1 PARAMETERS
# ===============================================
QC_CUTOFF = 10.5
DET_PTYPE = m+u
DET_PTHRESHOLD = 0.05
FUNNORM_SEED = 123
PVAL_THRESHOLD = 0.01
CHR_TO_REMOVE = chrX,chrY
SNPS_TO_REMOVE = SBE,CpG
CROSS_REACTIVE_FILE = $(DATA_DIR)/$(STEP1)/12864_2024_10027_MOESM8_ESM.csv
MAF_THRESHOLD = 0.1
PLOT_GROUP_VAR = TreatvControl_Time1_vs_Time2
LC_REF = salivaEPIC

# ===============================================
# STEP 2 PARAMETERS
# ===============================================
CTRL_SVA_PERC_VAR = 0.90
CTRL_SVA_FLAG = 1

# ===============================================
# STEP 3 PARAMETERS
# ===============================================
TIMEPOINTS = 1,2
COMBINE_TIMEPOINTS = 1,2

# ===============================================
# STEP 4 PARAMETERS
# ===============================================
GLM_LIBS = glm2
INTERACTION_GLM = NULL
SUMMARY_RESIDUAL_SD = TRUE
SAVE_SIGNIFICANT_CPGS = TRUE
SIGNIFICANT_CPG_PVAL = 0.1

# ==============================================
# STEP 5 PARAMETERS
# ==============================================
PERSON_VAR = person
LME_LIBS = lme4,lmerTest
INTERACTION_LME = TreatvControl_Time1_vs_Time2
SAVE_SIGNIFICANT_INTERACTIONS = TRUE
SIGNIFICANT_INTERACTION_PVAL = 0.1

# ===============================================
# ARGUMENT NORMALISATION
# ===============================================

ifeq ($(PRS_MAP),NULL)
  PRS_MAP_ARG = NULL
else
  PRS_MAP_ARG = '$(PRS_MAP)'
endif

ifeq ($(R_DIR),NULL)
  R_DIR_ARG = NULL
else
  R_DIR_ARG = '$(R_DIR)'
endif

ifeq ($(INTERACTION_GLM),NULL)
  INTERACTION_GLM_ARG = NULL
else
  INTERACTION_GLM_ARG = '$(INTERACTION_GLM)'
endif

ifeq ($(INTERACTION_LME),NULL)
  INTERACTION_LME_ARG = NULL
else
  INTERACTION_LME_ARG = '$(INTERACTION_LME)'
endif

# ===============================================
# INCLUDE PIPELINE FROM dnaEPICO
# ===============================================
DNAPIPE_MK := $(shell Rscript -e "cat(system.file('extdata','make','Makefile.rules.pipeline',package='dnaEPICO'))")
include $(DNAPIPE_MK)
```

### Model selection

- MODEL ?= model1
- MODELS = modelA modelB modelC

* `MODEL` defines **a single pipeline configuration**
* `MODELS` defines **multiple independent configurations**

The same pipeline can therefore be run in two modes:

**Single-model execution**


- make f4 MODEL=modelA


**Parallel multi-model execution**

- make f4_models

In parallel mode, **each model runs as a fully independent pipeline**, with its own inputs, logs, figures, and outputs. No files are shared between models except the raw inputs (IDATs), unless explicitly specified.


## Per-model overrides

```make
ifeq ($(MODEL), modelA)
  PHENO_FILE = data/preprocessingMinfiEwasWater/phenoA.csv
...
else
  PHENO_FILE = data/preprocessingMinfiEwasWater/pheno.csv
endif
```

This block **dynamically replaces variables** based on the selected model.

* The Makefile is evaluated **at runtime**
* When `MODEL=modelA`, `PHENO_FILE` is replaced before any step runs
* The rest of the pipeline remains unchanged

This allows users to:

* compare cohorts or subgroup definitions,
* test alternative phenotype encodings,
* run sensitivity analyses,

without duplicating code or Makefiles.

### Directory and step conventions

- STEP1 = preprocessingMinfiEwasWater
- STEP2 = svaEnmix
- STEP3 = preprocessingPheno
- STEP4 = methylationGLM_T1
- STEP5 = methylationGLMM_T1T2

Each step writes outputs into **step-specific directories**. When running in parallel, directory paths are automatically namespaced by model, ensuring isolation between runs.

This design allows:

* restarting individual steps,
* debugging failed models independently,
* mixing local and HPC execution safely.

## Global parameters

- PHENO_FILE = ...
- SAMPLE_ID = ...
- TIME_VAR = ...
- ...

These parameters are **shared across preprocessing and modelling**.

Their definitions and expected formats are explained in the *Local use* section and are not repeated here.

### Specific parameters

- PHENOTYPES = TreatmentGroup
- COVARIATES = Sex
- FACTOR_VARS = Sex,TreatmentGroup
- N_CORES = 64
- CHUNK_SIZE = 10000
- ...

These parameters control **how each model is fit**. In parallel execution:

* `N_CORES` controls **intra-model parallelism** (within R)
* `MODELS` controls **inter-model parallelism** (within Make)

Their definitions and expected formats are explained in the *Local use* section and are not repeated here.

### Argument normalisation

```make
ifeq ($(PRS_MAP),NULL)
  PRS_MAP_ARG = NULL
else
  PRS_MAP_ARG = '$(PRS_MAP)'
endif
if ...
```

This section ensures that optional arguments are passed correctly to R scripts. It prevents accidental interpretation of the string `"NULL"` as a real value and guarantees consistent behaviour across local and cluster environments.

# Reporting

`dnamReport()` generates a PDF report by rendering `DNAm.Rmd` through a runner script (`DNAm.R`) shipped in `inst/scripts`.

```{r, eval=FALSE}
dnamReport(
  output = "DNAm_Report.pdf",
  outputDir = "reports",
  qcDir = "figures/preprocessingMinfiEwasWater/enMix",
  preprocessingDir = "figures/preprocessingMinfiEwasWater/qc",
  postprocessingDir = "figures/preprocessingMinfiEwasWater/metrics",
  svaDir = "figures/svaEnmix/sva",
  glmDir = "figures/methylationGLM_T1",
  glmmDir = "figures/methylationGLMM_T1T2",
  reportTitle = "DNA methylation",
  author = "School of Biomedical Sciences",
  date = format(Sys.Date(), "%B %d, %Y")
)
```

# Troubleshooting

* If a step “fails”, check logs in `logs/`.
* If Make targets are missing, confirm:
  * correct `include Makefile.rules.pipeline`
  
# Example Analysis

The following examples are brief demonstrations on how to perform DNA methylation analysis using `dnaEPICO` functions and arguments.

This example has the following dependencies

```{r dependencies, warning=FALSE, message=FALSE, eval=FALSE}
library(dnaEPICO)
library(ewastools)

```

```{r, warning=FALSE, message=FALSE}
library(minfiData)
library(minfi)

```

##  Example 1: Local Test

The aim of this example is to show **how to run the complete `dnaEPICO` pipeline** using the example dataset provided by the `minfiData` package.

This example is designed to:

- help new users understand the pipeline structure  
- demonstrate how data and results are organised on disk  
- provide a safe, reproducible way to test the pipeline  

To avoid creating permanent files on the user’s computer, **all steps are run inside a temporary directory**.  

When analysing real data, users can simply replace the temporary directory with their own project folder.

### Overview of example 1

In this example, the pipeline performs the following steps:

1. Stage raw input data (IDAT files and phenotype data)  
2. Perform DNA methylation preprocessing and quality control  
3. Estimate surrogate variables (technical variation)  
4. Prepare phenotype-aligned methylation matrices  
5. Generate figures and a summary PDF report  

### Step 1: Create a temporary working directory

We first create a temporary directory that will hold **all input files and outputs** for this example.

```{r, message=FALSE, warning=FALSE, include=TRUE}
# Temporary directory 
tmpDir  <- file.path(tempdir(), "dnaEPICO_Test")
dir.create(tmpDir, showWarnings = FALSE, recursive = TRUE)

```

```{r, message=FALSE, warning=FALSE, include=TRUE}
preprocDir <- file.path(tmpDir, "data", "preprocessingMinfiEwasWater")
dir.create(preprocDir, showWarnings = FALSE, recursive = TRUE)

# Register automatic cleanup when the vignette exits
on.exit(unlink(tmpDir, recursive = TRUE, force = TRUE), add = TRUE)

tmpDir

```

**Important:**

* This directory is created only for this example
* It will be deleted automatically at the end
* Users analysing real data should use a permanent directory instead

### Step 2: Load example IDAT files from minfiData

The `minfiData` package contains a small set of Illumina 450K IDAT files tfrom blood samples.

```{r download-raw, message=FALSE, warning=FALSE }
# Locate minfiData extdata directory
baseDir_minfi <- system.file("extdata", package = "minfiData")

```

```{r, message=FALSE, warning=FALSE }
# Find all IDAT files
idatFiles <- list.files(
  baseDir_minfi,
  pattern = "\\.idat$",
  recursive = TRUE,
  full.names = TRUE
)

length(idatFiles)

```

We now copy these IDAT files into the directory structure expected by `dnaEPICO`.

```{r}
# Create IDAT directory
idatDir <- file.path(preprocDir, "idats")
dir.create(idatDir, showWarnings = FALSE, recursive = TRUE)

```

```{r}
# Copy IDATs into idatDir
file.copy(idatFiles, idatDir, overwrite = TRUE)

length(list.files(idatDir, pattern = "\\.idat$"))

```

### Step 3: Copy the cross-reactive probe annotation file

The pipeline requires a file listing cross-reactive probes. This file is distributed with `dnaEPICO` and is copied into the preprocessing folder. It is a reduced version of the original file, which can be accessed from the following link:

- [`12864_2024_10027_MOESM8_ESM.csv`](https://springernature.figshare.com/articles/dataset/Additional_file_8_of_Characterisation_and_reproducibility_of_the_HumanMethylationEPIC_v2_0_BeadChip_for_DNA_methylation_profiling/26689706?file=48531323)

```{r}
# Locate dnaEPICO extdata directory
baseDir_dnaEPICO <- system.file("extdata", package = "dnaEPICO")

```

```{r}
# Source cross-reactive probe file
crossReactiveSrc <- file.path(baseDir_dnaEPICO, "12864_2024_10027_MOESM8_ESM.csv")

```

```{r}
# Destination path inside tmpDir/data/preprocessingMinfiEwasWater/
crossReactivePath <- file.path(preprocDir, "12864_2024_10027_MOESM8_ESM.csv")

```

```{r}
# Copy into the target folder
file.copy(crossReactiveSrc, crossReactivePath, overwrite = TRUE)
file.exists(crossReactivePath)

```

### Step 4: Create a phenotype file

Next, we create a phenotype file using the sample sheet provided by `minfiData`.

```{r}
# Read SampleSheet from minfiData
targets <- read.csv(
  file.path(baseDir_minfi, "SampleSheet.csv"),
  stringsAsFactors = FALSE,
  skip = 7
)

```

```{r}
# Create Basename column 
targets$Basename <- paste0(
  targets$Sentrix_ID,
  "_",
  targets$Sentrix_Position
)

```

```{r}
# Create Timepoint column
targets$Timepoint <- 1

```

```{r}
# Write phenotype file
samplePath <- file.path(preprocDir, "sample_minfi.csv")
write.csv(targets, samplePath, row.names = FALSE)

file.exists(samplePath)

```

This phenotype file will be used throughout the pipeline.

## Step 5: Preprocessing and quality control

We now run the first pipeline stage, which performs:

* reading of IDAT files
* quality control
* normalisation
* probe filtering
* generation of QC figures

```{r, eval=FALSE}
preprocessingMinfiEwasWater(
  phenoFile = samplePath,
  idatFolder = file.path(preprocDir, "idats"),
  nSamples = NA,
  SampleID = "Sample_Name",
  phenoOrder = "Sample_Name;sex;Basename;Sentrix_ID;Sentrix_Position",
  arrayType = "IlluminaHumanMethylation450k",
  annotationVersion = "ilmn12.hg19",
  sexColumn = "sex",
  plotGroupVar = "sex",
  tiffWidth = 2000,
  tiffHeight = 1000,
  tiffRes = 150,
  qcCutoff = 10.5,
  detPtype = "m+u",
  detPThreshold = 0.05,
  funnormSeed = 123,
  normMethods = "adjustedfunnorm",
  pvalThreshold = 0.01,
  chrToRemove = "chrX,chrY",
  snpsToRemove = "SBE,CpG",
  mafThreshold = 0.1,
  outputLogs = file.path(tmpDir, "logs"),
  baseDataFolder = file.path(tmpDir, "rData"),
  figureBaseDir = file.path(tmpDir, "figures"),
  lcRef = "FlowSorted.Blood.450k",
  crossReactivePath = file.path(preprocDir, "12864_2024_10027_MOESM8_ESM.csv"),
  lcPhenoDir = preprocDir
)

```

### Step 6: Surrogate variable analysis (SVA)

Next, we estimate surrogate variables to capture technical variation such as chip and position effects.

```{r}
rgsetPath <- file.path(
  tmpDir,
  "rData",
  "preprocessingMinfiEwasWater",
  "objects",
  "RGSet.RData"
)

file.exists(rgsetPath)

```

```{r, eval=FALSE}
svaEnmix(
  phenoFile = samplePath,
  rgsetData = rgsetPath,
  sepType = "",
  outputLogs = file.path(tmpDir, "logs"),
  nSamples = NA,
  SampleID = "Sample_Name",
  arrayType = "IlluminaHumanMethylation450k",
  annotationVersion = "ilmn12.hg19",
  SentrixIDColumn = "Sentrix_ID",
  SentrixPositionColumn = "Sentrix_Position",
  ctrlSvaPercVar = 0.90,
  ctrlSvaFlag = 1,
  scriptLabel = "svaEnmix",
  tiffWidth = 2000,
  tiffHeight = 1000,
  tiffRes = 150,
  dataBaseDir = file.path(tmpDir, "data") ,
  figureBaseDir = file.path(tmpDir, "figures")
  
)

```

### Step 7: Phenotype preprocessing

This step aligns phenotype data with the processed methylation matrices.

```{r}
# Metric paths produced by preprocessingMinfiEwasWater
betaPath <- file.path(
  tmpDir,
  "rData",
  "preprocessingMinfiEwasWater",
  "metrics",
  "beta_NomFilt_MSetF_Flt_Rxy_Ds_Rc.RData"
)

```

```{r}
mPath <- file.path(
  tmpDir,
  "rData",
  "preprocessingMinfiEwasWater",
  "metrics",
  "m_NomFilt_MSetF_Flt_Rxy_Ds_Rc.RData"
)

```

```{r}
cnPath <- file.path(
  tmpDir,
  "rData",
  "preprocessingMinfiEwasWater",
  "metrics",
  "cn_NomFilt_MSetF_Flt_Rxy_Ds_Rc.RData"
)

```

```{r}
# Quick sanity check
file.exists(betaPath)
file.exists(mPath)
file.exists(cnPath)

```

```{r, eval=FALSE}
preprocessingPheno(
  phenoFile = samplePath,
  sepType = "",
  betaPath = betaPath,
  mPath = mPath,
  cnPath = cnPath,
  SampleID = "Sample_Name",
  timeVar = "Timepoint",
  timepoints = "1",
  combineTimepoints = "1",
  sexColumn = "sex",
  outputPheno = file.path(tmpDir, "data", "preprocessingPheno"),
  outputRData = file.path(tmpDir, "rData", "preprocessingPheno", "metrics"),
  outputRDataMerge = file.path(tmpDir, "rData", "preprocessingPheno", "mergeData"),
  outputLogs = file.path(tmpDir, "logs"),
  outputDir = file.path(tmpDir, "data", "preprocessingPheno")
)

```

### Step 8: Generate a PDF report

Finally, we generate a summary report that compiles figures and results from all previous steps.

```{r, eval=FALSE}
dnamReport(
  output = "DNAm_Report.pdf",
  outputDir = file.path(tmpDir, "reports"),

  qcDir = file.path(
    tmpDir, "figures", "preprocessingMinfiEwasWater", "enMix"
  ),
  preprocessingDir = file.path(
    tmpDir, "figures", "preprocessingMinfiEwasWater", "qc"
  ),
  postprocessingDir = file.path(
    tmpDir, "figures", "preprocessingMinfiEwasWater", "metrics"
  ),
  svaDir = file.path(
    tmpDir, "figures", "svaEnmix"
  ),
  glmDir = file.path(
    tmpDir, "figures", "methylationGLM_T1"
  ),
  glmmDir = file.path(
    tmpDir, "figures", "methylationGLMM_T1T2"
  ),

  reportTitle = "DNA methylation",
  author = "School of Biomedical Sciences",
  date = format(Sys.Date(), "%B %d, %Y")
)

```

## Example 2: Cluster Test

For large studies or cluster environments, the same workflow can be executed via a Makefile.

```{r, message=TRUE, warning=FALSE, eval=FALSE}
# Extract Makefile
extractMake(destDir = tmpDir)

oldWd <- getwd()
setwd(tmpDir)
on.exit(setwd(oldWd), add = TRUE)

system("make f3 MODEL=minfiData")

```

### Step 1: Selecting a single test model

- MODEL ?= minfiData 

For this example, the pipeline is run using **one explicit model** (`minfiData`) rather than multiple parallel models.
This mirrors the single-dataset workflow demonstrated earlier in R.

### Step 2: Using the example phenotype file

- PHENO_FILE = $(DATA_DIR)/$(STEP1)/sample_minfi.csv  

The phenotype file generated from `minfiData` (`sample_minfi.csv`) is used for consistency between:

* interactive R execution
* Makefile-driven execution

### Step 3: Removing custom R library paths

- R_DIR = NULL

Setting `R_DIR = NULL` tells the pipeline to use the **default R library paths**, which is appropriate for:

* local testing
* vignette examples
* containerised or module-based HPC environments

### Step 4: Matching columns


- GLOBAL PARAMETERS
  - SAMPLE_ID = Sample_Name 
  - ARRAY_TYPE = IlluminaHumanMethylation450k 
  - ANNOTATION_VERSION = ilmn12.hg19
  - SEX_COLUMN = sex
  - SENTRIX_ID_COLUMN = Sentrix_ID 
  - SENTRIX_POSITION_COLUMN = Sentrix_Position 

These parameters ensure the Makefile uses the:

* correct sample identifier, 
* correct array platform and annotation, and 
* correct sex column and chip metadata

### Step 5: Plot grouping and cell composition reference

- PLOT_GROUP_VAR = sex 
- LC_REF = Reinius 

* Plots are grouped by `sex`, matching earlier QC figures
* `Reinius` is selected as the reference panel because `minfiData` represents blood samples

### Step 6: Timepoint

- TIMEPOINTS = 1 
- COMBINE_TIMEPOINTS = 1

The example dataset contains a **single timepoint**, so longitudinal logic is disabled.

# Basics

Date the vignette was generated.

```{r reproduce1, echo=FALSE}
## Date the vignette was generated
Sys.time()
```

Wallclock time spent generating the vignette.

```{r reproduce2, echo=FALSE}
## Processing time in seconds
totalTime <- diff(c(startTime, Sys.time()))
round(totalTime, digits = 3)
```

`R` session information.

```{r echo=FALSE}
sessionInfo()
```

## Acknowledgement

This package was developed using `r BiocStyle::Biocpkg("biocthis")`.

This vignette was generated using `r Biocpkg("BiocStyle")`, with `r CRANpkg("knitr")` and `r CRANpkg("rmarkdown")` running behind the scenes.

## Required knowledge

`r Biocpkg("dnaEPICO")` is built on core Bioconductor infrastructure for high-dimensional genomic data, with a focus on Illumina DNA methylation arrays. 

Preprocessing and quality control are performed using established Bioconductor tools, including `r Biocpkg("minfi")`, `r Biocpkg("ENmix")`, and `r Biocpkg("wateRmelon")`. Additional functionality is provided via the `ewastools` package, which is installed from GitHub using `devtools::install_github("hhhh5/ewastools")`. Downstream statistical modelling relies on base R and CRAN frameworks, including generalised linear models and linear mixed-effects models. Users are expected to have basic familiarity with R, command-line execution, and Illumina IDAT file structures. Downstream statistical modelling relies on base R and CRAN frameworks, including generalised linear models and linear mixed-effects models. Users are expected to have basic familiarity with R, command-line execution, and Illumina IDAT file structures.

If you are asking yourself the question "Where do I start using Bioconductor?" you might be interested in [this blog post](http://lcolladotor.github.io/2014/10/16/startbioc/#.VkOKbq6rRuU).

## Asking for help

As package developers, we try to explain clearly how to use our packages and in which order to use the functions. But `R` and `Bioconductor` have a steep learning curve so it is critical to learn where to ask for help. The blog post quoted above mentions some but we would like to highlight the [Bioconductor support site](https://support.bioconductor.org/) as the main resource for getting help: remember to use the `dnaEPICO` tag and check [the older posts](https://support.bioconductor.org/tag/dnaEPICO/). Other alternatives are available such as creating GitHub issues and tweeting. However, please note that if you want to receive help you should adhere to the [posting guidelines](http://www.bioconductor.org/help/support/posting-guide/). It is particularly critical that you provide a small reproducible example and your session information so package developers can track down the source of the error.

# References

